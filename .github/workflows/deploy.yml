name: CI/CD Pipeline (Auto Deploy)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  AWS_REGION: ap-northeast-2
  # ğŸ‘‡ [ìˆ˜ì • 1] ì•„ê¹Œ ë§Œë“  ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ìœ¼ë¡œ í†µì¼ (ìƒˆë¡œ ë§Œë“¤ì—ˆë‹¤ë©´ ê·¸ ì´ë¦„ìœ¼ë¡œ)
  ECR_REPOSITORY: gitactions 
  ECR_REGISTRY: 639242342449.dkr.ecr.ap-northeast-2.amazonaws.com
  IMAGE_TAG: v${{ github.run_number }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # ğŸ‘‡ [ìˆ˜ì • 2] Java 17 ì„¸íŒ… ì¶”ê°€ (ë¹Œë“œ ì•ˆì •ì„± í™•ë³´)
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # AWS ë¡œê·¸ì¸
    - name: Configure AWS and Login to ECR
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    - uses: aws-actions/amazon-ecr-login@v2
    
    # 1. ë¹Œë“œ ë° ECR ì—…ë¡œë“œ
    - name: Build, tag, and push image to Amazon ECR
      run: |
        chmod +x mvnw
        ./mvnw clean package -DskipTests
        
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        # latest íƒœê·¸ ì—…ë°ì´íŠ¸
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    # 2. K8s YAML íŒŒì¼ ìˆ˜ì •
    - name: Update Deployment YAML with new image tag
      run: |
        WAS_YAML_PATH="k8s/was-deployment.yaml"
        
        # ğŸ‘‡ [ìˆ˜ì • 3] sed íŒ¨í„´ ë³€ê²½: ê¸°ì¡´ ì´ë¦„ì´ ë­ë“  ê°„ì— ECR ì£¼ì†Œ ë¼ì¸ì„ í†µì§¸ë¡œ êµì²´ (ê°€ì¥ ì•ˆì „)
        sed -i "s|image: .*dkr.ecr.*|image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" $WAS_YAML_PATH
        
        # í™•ì¸
        cat $WAS_YAML_PATH

    # 3. Git ì»¤ë°‹ & í‘¸ì‹œ
    - name: Commit and Push Updated YAML
      uses: EndBug/add-and-commit@v9
      with:
        message: 'GitOps: Deploy new image version ${{ env.IMAGE_TAG }}'
        add: 'k8s/was-deployment.yaml' # ğŸ‘ˆ (ì›ë˜ ì½”ë“œì— ë”°ì˜´í‘œê°€ ë¹ ì ¸ìˆì–´ì„œ ì±„ì›Œë“œë ¸ìŠµë‹ˆë‹¤)
