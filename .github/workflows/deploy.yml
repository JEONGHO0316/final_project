name: CI/CD Pipeline (Auto Deploy)

on:
  push:
    branches: [ "main" ]

# ğŸ’¡ GitOps í•µì‹¬: GitHub Actionsì´ Gitì— ë‹¤ì‹œ ì»¤ë°‹(ìˆ˜ì •)í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write 

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: petclinic-app
  # ë‹˜ì˜ ECR ì£¼ì†Œ (ìˆ˜ì • ë¶ˆí•„ìš”)
  ECR_REGISTRY: 639242342449.dkr.ecr.ap-northeast-2.amazonaws.com
  IMAGE_TAG: v${{ github.run_number }} # âœ… ì´ë¯¸ì§€ íƒœê·¸ë¥¼ í˜„ì¬ Git Commit SHA(ê³ ìœ ê°’)ë¡œ ì •ì˜

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # AWS ë¡œê·¸ì¸
    - name: Configure AWS and Login to ECR
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    - uses: aws-actions/amazon-ecr-login@v2
    
    # 1. ë¹Œë“œ ë° ECR ì—…ë¡œë“œ (SHA íƒœê·¸ ì‚¬ìš©)
    - name: Build, tag, and push image to Amazon ECR
      run: |
        chmod +x mvnw
        ./mvnw clean package -DskipTests
        
        # SHA íƒœê·¸ë¡œ ë¹Œë“œ ë° í‘¸ì‹œ (ArgoCDê°€ ì“¸ ê²ƒ)
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        # (ì„ íƒ) latest íƒœê·¸ë„ ê·¸ëƒ¥ ì—…ë°ì´íŠ¸ í•´ë‘ 
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    # 2. K8s YAML íŒŒì¼ ìˆ˜ì • (ì—¬ê¸°ê°€ ìë™ ë°°í¬ì˜ í•µì‹¬!)
    # sed ëª…ë ¹ì–´ë¡œ YAML íŒŒì¼ ì•ˆì˜ ì´ë¯¸ì§€ íƒœê·¸ ë¶€ë¶„ì„ ì°¾ì•„ë‚´ì„œ ì´ë²ˆ SHA íƒœê·¸ë¡œ ë°”ê¿”ì¹˜ê¸° í•©ë‹ˆë‹¤.
    - name: Update Deployment YAML with new image tag
      run: |
        WAS_YAML_PATH="k8s/was-deployment.yaml"
        # :ë’¤ì— ì˜¤ëŠ” íƒœê·¸ê°€ ë¬´ì—‡ì´ë“  ê°„ì—, ìƒˆë¡œìš´ $IMAGE_TAGë¡œ êµì²´í•˜ë¼ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.
        sed -i "s|image: .*$ECR_REPOSITORY:.*|image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" $WAS_YAML_PATH
        
        # ì˜ ë°”ë€Œì—ˆë‚˜ ëˆˆìœ¼ë¡œ í™•ì¸ (ë¡œê·¸ì— ì°í˜)
        cat $WAS_YAML_PATH

    # 3. ìˆ˜ì •ëœ YAML íŒŒì¼ì„ Gitì— ìë™ ì»¤ë°‹ & í‘¸ì‹œ (ArgoCDê°€ ì´ê±¸ ë³´ê³  ë°°í¬ ì‹œì‘)
    - name: Commit and Push Updated YAML
      uses: EndBug/add-and-commit@v9
      with:
        message: 'GitOps: Deploy new image version ${{ env.IMAGE_TAG }}'
        add: 'k8s/was-deployment.yaml'
